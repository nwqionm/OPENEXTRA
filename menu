#!/bin/bash

clear

IP=$(ip addr | grep 'inet' | grep -v inet6 | grep -vE '127\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | grep -o -E '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | head -1)
if [[ "$IP" = "" ]]; then
	IP=$(wget -4qO- "http://whatismyip.akamai.com/")
fi

# Color
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# Menu
echo ""
echo -e "${RED}  (\_(\  ${NC}"
echo -e "${RED} (=’ :’) :* ${NC} Script by Mnm Ami"
echo -e "${RED}  (,(”)(”) °.¸¸.• ${NC}"
echo ""
echo -e "MENU SCRIPT ${RED}✿.｡.:* *.:｡✿*ﾟ’ﾟ･✿.｡.:*${NC}"
echo ""
echo -e "|${RED} 1${NC}| ADD NEW CLIENT"
echo -e "|${RED} 2${NC}| REMOVE CLIENT"
echo -e "|${RED} 3${NC}| CHECK ALL CLIENT"
echo -e "|${RED} 4${NC}| CHECK ALL CLIENT ONLINE"
echo -e "|${RED} 5${NC}| RENEW EXPIRE DATE OF CLIENT"
echo -e "|${RED} 6${NC}| SET TIME AUTO REBOOT SERVER"
echo -e "|${RED} 7${NC}| "
echo -e "|${RED} 8${NC}| "
echo -e "|${RED} 9${NC}| "
echo -e "|${RED}10${NC}| UPDATE MENU SCRIPT"
echo ""
if [[ -e /var/www/html/vnstat ]]; then
	echo -e "${RED}-${NC} VNSTAT : http://$IP/vnstat"
fi
echo ""
	cat /etc/shadow | cut -d: -f1,8 | sed /:$/d > /usr/local/bin/Expire-List
	TOTALACCOUNTS=`cat /usr/local/bin/Expire-List | wc -l`
	for((i=1; i<=$TOTALACCOUNTS; i++ ))
		do
		TCLIENTVAL=`head -n $i /usr/local/bin/Expire-List | tail -n 1`
		CLIENT=`echo $TCLIENTVAL | cut -f1 -d:`
		CLIENTEXP=`echo $TCLIENTVAL | cut -f2 -d:`
		CLIENTEXPIREINSECONDS=$(( $CLIENTEXP * 86400 ))
		TODAYSTIME=`date +%s`

		if [ $CLIENTEXPIREINSECONDS -ge $TODAYSTIME ] ; then
			TIMETO1DAYS=$(( $TODAYSTIME + 86400 ))
				if [ $CLIENTEXPIREINSECONDS -le $TIMETO1DAYS ]; then
					echo -e "     ${RED}$CLIENT${NC} จะหมดอายุอีกไม่เกิน 24 ชั่วโมง"
				fi
		else
			userdel -r "$CLIENT"
			cd /etc/openvpn/easy-rsa/
			./easyrsa --batch revoke $CLIENT
			EASYRSA_CRL_DAYS=3650 ./easyrsa gen-crl
			rm -rf pki/reqs/$CLIENT.req
			rm -rf pki/private/$CLIENT.key
			rm -rf pki/issued/$CLIENT.crt
			rm -rf /etc/openvpn/crl.pem
			cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem
			chmod 644 /etc/openvpn/crl.pem
			rm -f /home/vps/public_html/$CLIENT.ovpn
# rm -f /usr/local/bin/Expire-List
			menu
			exit
		fi
	done
echo ""
read -p "Select a Menu Script : " MENU

case $MENU in

	1)

clear

newclient () {
	cp /etc/openvpn/client-common.txt ~/$1.ovpn
	echo "<ca>" >> ~/$1.ovpn
	cat /etc/openvpn/easy-rsa/pki/ca.crt >> ~/$1.ovpn
	echo "</ca>" >> ~/$1.ovpn
	echo "<cert>" >> ~/$1.ovpn
	cat /etc/openvpn/easy-rsa/pki/issued/$1.crt >> ~/$1.ovpn
	echo "</cert>" >> ~/$1.ovpn
	echo "<key>" >> ~/$1.ovpn
	cat /etc/openvpn/easy-rsa/pki/private/$1.key >> ~/$1.ovpn
	echo "</key>" >> ~/$1.ovpn
	echo "<tls-auth>" >> ~/$1.ovpn
	cat /etc/openvpn/ta.key >> ~/$1.ovpn
	echo "</tls-auth>" >> ~/$1.ovpn
}

read -p "ชื่อลูกค้า : " -e CLIENT


if [[ -e /home/vps/public_html/$CLIENT.ovpn ]]; then
	echo ""
	echo "ชื่อลูกค้าที่ระบุอยู่ในระบบแล้ว"
	echo ""
	read -p "กลับไปที่เมนู (Y or N) : " -e -i Y REMOVE

	if [[ "$REMOVE" = 'Y' ]]; then
		menu
		exit
	elif [[ "$REMOVE" = 'N' ]]; then
		exit
	fi
fi

read -p "วันหมดอายุ : " -e TimeActive

cd /etc/openvpn/easy-rsa/
./easyrsa build-client-full $CLIENT nopass
newclient "$CLIENT"
cp /root/$CLIENT.ovpn /home/vps/public_html/
rm -f /root/$CLIENT.ovpn
useradd -e `date -d "$TimeActive days" +"%Y-%m-%d"` -s /bin/false -M $CLIENT
EXP="$(chage -l $CLIENT | grep "Account expires" | awk -F": " '{print $2}')"
echo -e "$CLIENT\n$CLIENT\n"|passwd $CLIENT &> /dev/null
echo ""
echo "ชื่อลูกค้า : $CLIENT"
echo "หมดอายุในวันที่ : $EXP"
echo "ดาวน์โหลดคอนฟิก : http://$IP:85/$CLIENT.ovpn"
echo ""
exit

	;;

	2)

clear
NUMBEROFCLIENTS=$(tail -n +2 /etc/openvpn/easy-rsa/pki/index.txt | grep -c "^V")
if [[ "$NUMBEROFCLIENTS" = '0' ]]; then
	echo ""
	echo "ไม่เคยมีลูกค้าอยู่ในระบบ"
	echo ""
	exit
fi

echo ""
tail -n +2 /etc/openvpn/easy-rsa/pki/index.txt | grep "^V" | cut -d '=' -f 2 | nl -s ') '
if [[ "$NUMBEROFCLIENTS" = '1' ]]; then
	echo ""
	echo -e "${RED}คำเตือน${NC} : การออกจากหน้านี้ต้องกด CTRL+C เท่านั้น"
	echo "หากกด Enter จะทำการลบชื่อลูกค้าลำดับที่ 1 โดยอัตโนมัติ"
	echo ""
	read -p "เลือกลำดับรายชื่อลูกค้าที่ต้องการลบ [1]: " CLIENTNUMBER
else
	echo ""
	echo -e "${RED}คำเตือน${NC} : การออกจากหน้านี้ต้องกด CTRL+C เท่านั้น"
	echo "         หากกด Enter จะทำการลบชื่อลูกค้าลำดับที่ 1 โดยอัตโนมัติ"
	echo ""
	read -p "เลือกลำดับรายชื่อลูกค้าที่ต้องการลบ [1 - $NUMBEROFCLIENTS]: " CLIENTNUMBER
fi

CLIENT=$(tail -n +2 /etc/openvpn/easy-rsa/pki/index.txt | grep "^V" | cut -d '=' -f 2 | sed -n "$CLIENTNUMBER"p)
cd /etc/openvpn/easy-rsa/
./easyrsa --batch revoke $CLIENT
EASYRSA_CRL_DAYS=3650 ./easyrsa gen-crl
rm -rf pki/reqs/$CLIENT.req
rm -rf pki/private/$CLIENT.key
rm -rf pki/issued/$CLIENT.crt
rm -rf /etc/openvpn/crl.pem
cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem
chown nobody:$GROUPNAME /etc/openvpn/crl.pem
rm -f /home/vps/public_html/$CLIENT.ovpn
userdel $CLIENT
echo ""
echo -e "ลูกค้าชื่อ ${RED}$CLIENT${NC} ถูกลบออกจากระบบเรียบร้อยแล้ว"
echo ""
exit

	;;

	3)

clear
UIDN=1000
echo ""
echo -e "${RED}รายชื่อลูกค้า          วันหมดอายุ ${NC} "
echo ""
while read CHECKCLIENT
do
	ACCOUNT="$(echo $CHECKCLIENT | cut -d: -f1)"
	ID="$(echo $CHECKCLIENT | grep -v nobody | cut -d: -f3)"
	EXP="$(chage -l $ACCOUNT | grep "Account expires" | awk -F": " '{print $2}')"
	if [[ $ID -ge $UIDN ]]; then
		printf "%-17s %2s\n" "$ACCOUNT" "$EXP"
	fi
done < /etc/passwd

TOTAL="$(awk -F: '$3 >= '$UIDN' && $1 != "nobody" {print $1}' /etc/passwd | wc -l)"
echo ""
echo -e "รวมรายชื่อลูกค้าทั้งหมด : ${RED}$TOTAL${NC}"
echo ""
exit

	;;

	4)

clear
if [ -f "/etc/openvpn/openvpn-status.log" ]; then
	line=`cat /etc/openvpn/openvpn-status.log | wc -l`
	a=$((3+((line-8)/2)))
	b=$(((line-8)/2))

	echo ""
	echo -e "${RED}รายชื่อลูกค้าที่กำลังออนไลน์ในขณะนี้ ${NC} ";
	echo ""
	cat /etc/openvpn/openvpn-status.log | head -n $a | tail -n $b | cut -d "," -f 1 | sed -e 's/,/   /g' > /usr/local/bin/Client-Login
	cat /usr/local/bin/Client-Login
	echo ""
	exit
fi

	;;


	5)

clear
echo ""
read -p "ชื่อลูกค้า : " -e CLIENT

if [[ ! -e /home/vps/public_html/$CLIENT.ovpn ]]; then
	echo ""
	echo "ไม่มีชื่อลูกค้าที่คุณระบุอยู่ในระบบ"
	echo ""
	read -p "กลับไปที่เมนู (Y or N) : " -e -i Y REMOVE

	if [[ "$REMOVE" = 'Y' ]]; then
		menu
		exit
	elif [[ "$REMOVE" = 'N' ]]; then
		exit
	fi
fi

EXP="$(chage -l $CLIENT | grep "Account expires" | awk -F": " '{print $2}')"
echo ""
echo -e "ชื่อลูกค้านี้หมดอายุในวันที่ ${RED}$EXP${NC}"
echo ""
read -p "เปลี่ยนวันหมดอายุ : " -e TimeActive

userdel $CLIENT
useradd -e `date -d "$TimeActive days" +"%Y-%m-%d"` -s /bin/false -M $CLIENT
EXP="$(chage -l $CLIENT | grep "Account expires" | awk -F": " '{print $2}')"
echo -e "$CLIENT\n$CLIENT\n"|passwd $CLIENT &> /dev/null
echo ""
echo "ชื่อลูกค้า : $CLIENT"
echo "หมดวันหมดในวันที่ : $EXP"
echo ""
exit

	;;

	6)

 if [ ! -e /usr/local/bin/Reboot-Server ]; then
	echo '#!/bin/bash' > /usr/local/bin/Reboot-Server
	echo '' >> /usr/local/bin/Reboot-Server
	echo 'DATE=$(date +"%m-%d-%Y")' >> /usr/local/bin/Reboot-Server
	echo 'TIME=$(date +"%T")' >> /usr/local/bin/Reboot-Server
	echo 'echo "รีบูทเมื่อวันที่ $DATE เวลา $TIME" >> /usr/local/bin/Reboot-Log' >> /usr/local/bin/Reboot-Server
	echo '/sbin/shutdown -r now' >> /usr/local/bin/Reboot-Server
	chmod +x /usr/local/bin/Reboot-Server
fi

clear
echo ""
echo -e "${RED}Set Time Auto Reboot Server${NC}"
echo ""
echo -e "|${RED}1${NC}| รีบูททุกๆ  1 ชั่วโมง"
echo -e "|${RED}2${NC}| รีบูททุกๆ  6 ชั่วโมง"
echo -e "|${RED}3${NC}| รีบูททุกๆ 12 ชั่วโมง"
echo -e "|${RED}4${NC}| รีบูททุกๆ  1 วัน"
echo -e "|${RED}5${NC}| รีบูททุกๆ  7 วัน"
echo -e "|${RED}6${NC}| รีบูททุกๆ 30 วัน"
echo -e "|${RED}7${NC}| หยุดการรีบูทเซิฟเวอร์"
echo -e "|${RED}8${NC}| ตรวจสอบบันทึกการรีบูทเซิฟเวอร์"
echo -e "|${RED}9${NC}| ลบบันทึกการรีบูทเซิฟเวอร์"
echo ""
read -p "Select a Menu : " REBOOT

case $REBOOT in

	1)

echo "0 * * * * root /usr/local/bin/Reboot-Server" > /etc/cron.d/Reboot-Server
echo ""
echo "ตั้งค่ารีบูทเซิฟเวอร์ทุกๆ 1 ชั่วโมงเรียบร้อยแล้ว"
echo ""
exit

	;;

	2)

echo "0 */6 * * * root /usr/local/bin/Reboot-Server" > /etc/cron.d/Reboot-Server
echo ""
echo "ตั้งค่ารีบูทเซิฟเวอร์ทุกๆ 6 ชั่วโมงเรียบร้อยแล้ว"
echo ""
exit

	;;

	3)

echo "0 */12 * * * root /usr/local/bin/Reboot-Server" > /etc/cron.d/Reboot-Server
echo ""
echo "ตั้งค่ารีบูทเซิฟเวอร์ทุกๆ 12 ชั่วโมงเรียบร้อยแล้ว"
echo ""
exit

	;;

	4)

echo "0 0 * * * root /usr/local/bin/Reboot-Server" > /etc/cron.d/Reboot-Server
echo ""
echo "ตั้งค่ารีบูทเซิฟเวอร์ทุกๆ 1 วันเรียบร้อยแล้ว"
echo ""
exit

	;;

	5)

echo "0 0 */7 * * root /usr/local/bin/Reboot-Server" > /etc/cron.d/Reboot-Server
echo ""
echo "ตั้งค่ารีบูทเซิฟเวอร์ทุกๆ 7 วันเรียบร้อยแล้ว"
echo ""
exit

	;;

	6)

echo "0 0 1 * * root /usr/local/bin/Reboot-Server" > /etc/cron.d/Reboot-Server
echo ""
echo "ตั้งค่ารีบูทเซิฟเวอร์ทุกๆ 30 วันเรียบร้อยแล้ว"
echo ""
exit

	;;

	7)

rm -f /usr/local/bin/Reboot-Server
echo ""
echo "หยุดการรีบูทเซิฟเวอร์เรียบร้อยแล้ว"
echo ""
exit

	;;

	8)

if [[ -e /usr/local/bin/Reboot-Log ]]; then
	echo ""
	echo "ไม่มีบันทึกการรีบูทเซิฟเวอร์"
	echo ""
	exit
else
	clear
	echo ""
	cat /usr/local/bin/Reboot-Log
	echo ""
	exit
fi

	;;

	9)

echo "" > /usr/local/bin/Reboot-Log
echo ""
echo "ลบบันทึกการรีบูทเซิฟเวอร์เรียบร้อยแล้ว"
echo ""
exit

	;;

esac

	;;

	7)
	;;

	8)

	;;

	9)
	;;

	10)

rm -f /usr/local/bin/menu
wget -O /usr/local/bin/menu "https://raw.githubusercontent.com/nwqionm/OPENEXTRA/master/menu"
chmod +x /usr/local/bin/menu

	;;

esac
